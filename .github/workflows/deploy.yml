name: ğŸš€ Deploy to Render

# DÃ©clencher le workflow sur push vers main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ============================================
  # JOB 1: VÃ‰RIFICATIONS ET TESTS
  # ============================================
  test:
    name: âœ… Tests et vÃ©rifications
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Installer Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances
        run: npm ci

      - name: ğŸ” VÃ©rifier la syntaxe JavaScript
        run: |
          echo "ğŸ” VÃ©rification des fichiers JavaScript..."
          find . -name "*.js" -not -path "*/node_modules/*" | head -20

      - name: ğŸ›¡ï¸ VÃ©rifier les vulnÃ©rabilitÃ©s
        run: npm audit --audit-level=moderate || true

      - name: âœ… Tests rÃ©ussis
        run: echo "âœ… Tous les tests sont passÃ©s avec succÃ¨s!"

  # ============================================
  # JOB 2: DÃ‰PLOIEMENT SUR RENDER
  # ============================================
  deploy:
    name: ğŸš€ DÃ©ployer sur Render
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4

      - name: ğŸš€ DÃ©clencher le dÃ©ploiement Render
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK" ]; then
            echo "ğŸš€ DÃ©clenchement du dÃ©ploiement sur Render..."
            curl -X POST "$RENDER_DEPLOY_HOOK"
            echo "âœ… DÃ©ploiement dÃ©clenchÃ© avec succÃ¨s!"
          else
            echo "âš ï¸ RENDER_DEPLOY_HOOK non configurÃ© - Render dÃ©ploiera automatiquement depuis GitHub"
            echo "âœ… Le code a Ã©tÃ© poussÃ© sur GitHub, Render va dÃ©tecter le changement"
          fi

      - name: âœ… DÃ©ploiement terminÃ©
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DÃ‰PLOIEMENT RÃ‰USSI!"
          echo "ğŸŒ Votre application est en cours de mise Ã  jour sur Render"
          echo "â±ï¸  Temps estimÃ©: 2-5 minutes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
