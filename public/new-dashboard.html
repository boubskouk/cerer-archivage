<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouveau Dashboard - GED CERER</title>
    <link rel="stylesheet" href="/css/new-dashboard.css">
</head>
<body>
    <!-- Top Navigation Bar -->
    <div class="topbar">
        <div class="topbar-logo">
            <div class="topbar-logo-icon">üéì</div>
            <div class="topbar-logo-text">
                <h2>GED CERER</h2>
                <p>Gestion √âlectronique Documents</p>
            </div>
        </div>

        <div class="topbar-user">
            <button onclick="window.location.href='/'"
                    class="version-switch-btn"
                    title="Retour √† la version classique">
                üìä Version Classique
            </button>
            <div class="user-info">
                <div class="user-name" id="userName">Chargement...</div>
                <div class="user-role">
                    <span id="userDepartment">-</span>
                    <span class="role-badge" id="userLevel">-</span>
                </div>
            </div>
            <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar" style="position: relative; overflow: hidden;">
                <img id="avatarPhoto" src="" alt="Photo de profil"
                     onerror="this.style.display='none'; document.getElementById('avatarInitials').style.display='flex';"
                     style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none;">
                <div id="avatarInitials" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                    --
                </div>
            </div>
        </div>
    </div>

    <!-- Beta Banner -->
    <div class="beta-banner">
        <div class="beta-banner-content">
            <span class="beta-badge">BETA</span>
            <span class="beta-text">üé® Vous utilisez le nouveau design ! Testez les nouvelles fonctionnalit√©s et donnez-nous votre avis.</span>
        </div>
    </div>

    <!-- User Menu Dropdown -->
    <div id="userMenu" class="user-menu">
        <div class="user-menu-header">
            <div class="user-menu-name" id="menuUserName">-</div>
            <div class="user-menu-email" id="menuUserEmail">-</div>
        </div>
        <!-- "Mon Profil" SUPPRIM√â pour raisons de s√©curit√© (modification niveau en beta) -->
        <div class="user-menu-item" onclick="alert('Fonctionnalit√© en d√©veloppement')">
            <span>‚öôÔ∏è</span>
            <span>Param√®tres</span>
        </div>
        <div class="user-menu-item" onclick="alert('Fonctionnalit√© en d√©veloppement')">
            <span>üîî</span>
            <span>Notifications</span>
        </div>
        <!-- ‚ùå "D√©connexion" SUPPRIM√â - Ne pas se d√©connecter depuis la version beta -->
    </div>

    <div class="container">
        <!-- HOME VIEW -->
        <div id="homeView">
            <!-- Header -->
            <div class="header">
                <h1>üìä Tableau de Bord</h1>
                <p>Bienvenue dans votre espace de gestion documentaire</p>
            </div>

            <!-- Stats Overview -->
            <div class="stats-overview" id="statsOverview">
                <div class="stat-card">
                    <div class="stat-icon">üè¢</div>
                    <div class="stat-info">
                        <h3>D√©partements</h3>
                        <p id="statDepts">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÇ</div>
                    <div class="stat-info">
                        <h3>Services</h3>
                        <p id="statServices">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÑ</div>
                    <div class="stat-info">
                        <h3>Documents</h3>
                        <p id="statDocuments">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíæ</div>
                    <div class="stat-info">
                        <h3>Stockage</h3>
                        <p id="statStorage">0 MB</p>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <div class="search-bar">
                    <input type="text" id="globalSearchInput" class="search-input"
                           placeholder="üîç Rechercher par titre, ID, d√©partement, service, cat√©gorie..."
                           onkeyup="if(event.key === 'Enter') performGlobalSearch()">
                    <button class="search-btn" onclick="performGlobalSearch()">Rechercher</button>
                </div>
                <div class="search-filters">
                    <span class="filter-label">Filtrer par:</span>
                    <label class="filter-checkbox">
                        <input type="checkbox" id="filterServices" checked>
                        <span>Services</span>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" id="filterCategories" checked>
                        <span>Cat√©gories</span>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" id="filterDocuments" checked>
                        <span>Documents</span>
                    </label>
                </div>
            </div>

            <!-- Search Results (Hidden by default) -->
            <div id="searchResults" class="search-results hidden">
                <!-- Results will be dynamically inserted here -->
            </div>

            <!-- Section Title -->
            <div class="section-title">
                <h2>üè¢ D√©partements</h2>
            </div>

            <!-- Departments Grid -->
            <div class="departments-grid" id="departmentsGrid">
                <!-- Departments will be dynamically loaded here -->
                <div class="loading">Chargement des d√©partements...</div>
            </div>
        </div>

        <!-- DEPARTMENT VIEW (Hidden by default) -->
        <div id="departmentView" class="department-view">
            <button class="back-btn" onclick="showHome()">‚Üê Retour √† l'accueil</button>

            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a onclick="showHome()">Accueil</a>
                <span>‚Ä∫</span>
                <strong id="currentDeptName">-</strong>
            </div>

            <!-- Department Header -->
            <div class="header">
                <h1 id="deptTitle">üìä Chargement...</h1>
                <p>Explorez les services et documents de ce d√©partement</p>
            </div>

            <!-- Department Stats -->
            <div class="stats-overview" id="deptStats">
                <div class="stat-card">
                    <div class="stat-icon">üìÇ</div>
                    <div class="stat-info">
                        <h3>Services</h3>
                        <p id="deptStatServices">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÑ</div>
                    <div class="stat-info">
                        <h3>Documents</h3>
                        <p id="deptStatDocuments">0</p>
                    </div>
                </div>
            </div>

            <!-- Services Accordion with Add Service Button -->
            <div class="section-title">
                <h2>üìÇ Services du d√©partement</h2>
                <button class="add-btn" onclick="openAddServiceModal()">
                    ‚ûï Ajouter un service
                </button>
            </div>

            <div class="accordion" id="servicesAccordion">
                <!-- Services will be dynamically loaded here -->
                <div class="loading">Chargement des services...</div>
            </div>

            <!-- Documents Section (Hidden until category clicked) -->
            <div id="documentsSection" class="hidden" style="margin-top: 30px;">
                <div class="breadcrumb">
                    <a onclick="showHome()">Accueil</a>
                    <span>‚Ä∫</span>
                    <a onclick="hideDocuments()"><span id="breadcrumbDept">-</span></a>
                    <span>‚Ä∫</span>
                    <span id="currentServiceName">-</span>
                    <span>‚Ä∫</span>
                    <strong id="currentCategoryName">-</strong>
                </div>

                <div class="section-title">
                    <h2>üìÑ <span id="categoryTitle">-</span> (<span id="docCount">0</span> documents)</h2>
                    <button class="add-btn" onclick="openAddDocumentModal()">
                        ‚ûï Ajouter un document
                    </button>
                </div>

                <!-- Document Filter -->
                <div class="document-filter">
                    <input type="text" id="documentFilterInput" class="filter-input"
                           placeholder="üîç Filtrer les documents par titre, auteur, date..."
                           oninput="debounceFilter()">
                </div>

                <!-- Document Controls (Tri et Pagination) -->
                <div class="document-controls">
                    <div class="control-group">
                        <span class="control-label">Trier par:</span>
                        <select class="control-select" id="sortSelect" onchange="sortDocuments()">
                            <option value="date-desc">Date (Plus r√©cent)</option>
                            <option value="date-asc">Date (Plus ancien)</option>
                            <option value="name-asc">Nom (A-Z)</option>
                            <option value="name-desc">Nom (Z-A)</option>
                            <option value="size-desc">Taille (Plus grand)</option>
                            <option value="size-asc">Taille (Plus petit)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Afficher:</span>
                        <select class="control-select" id="perPageSelect" onchange="changePerPage()">
                            <option value="20">20 par page</option>
                            <option value="50">50 par page</option>
                            <option value="100">100 par page</option>
                        </select>
                    </div>
                </div>

                <div class="documents-grid" id="documentsGrid">
                    <!-- Documents will be dynamically loaded here -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="paginationContainer">
                    <div class="pagination-info" id="paginationInfo">
                        Affichage 0-0 sur 0 documents
                    </div>
                    <div class="pagination" id="pagination">
                        <!-- Pagination buttons will be dynamically generated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Department Modal -->

    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="serviceModalTitle">üìÇ Ajouter un service</h2>
                <span class="modal-close" onclick="closeAddServiceModal()">√ó</span>
            </div>
            <form onsubmit="submitService(event)">
                <input type="hidden" id="serviceId" value="">
                <div class="form-group">
                    <label class="form-label">Nom du service *</label>
                    <input type="text" class="form-input" id="serviceName" placeholder="Ex: Biologie Mol√©culaire" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ic√¥ne (emoji)</label>
                    <input type="text" class="form-input" id="serviceIcon" placeholder="Ex: üß¨" maxlength="2">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="serviceDescription" placeholder="Description du service..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddServiceModal()">Annuler</button>
                    <button type="submit" class="btn-submit" id="serviceSubmitBtn">Cr√©er le service</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Document Modal -->
    <div id="addDocumentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì§ Ajouter un document</h2>
                <span class="modal-close" onclick="closeAddDocumentModal()">√ó</span>
            </div>
            <form onsubmit="submitDocument(event)">
                <!-- Contexte d'ajout -->
                <div id="contextInfo" style="display: none;"></div>

                <div class="form-group">
                    <label class="form-label">Titre du document *</label>
                    <input type="text" class="form-input" id="docTitle" placeholder="Ex: M√©moire de Master 2024" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Cat√©gorie *</label>
                    <select class="form-select" id="docCategory" required onchange="updateArchivePath()">
                        <option value="">-- S√©lectionner une cat√©gorie --</option>
                    </select>
                    <div id="archivePath" style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 4px; display: none;">
                        <div style="font-size: 12px; color: #1e40af; font-weight: 600; margin-bottom: 5px;">üìÅ Chemin d'archivage :</div>
                        <div id="archivePathText" style="font-size: 13px; color: #1e3a8a;"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="docDescription" placeholder="Description du document (optionnelle)"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Fichier *</label>
                    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                        <div class="file-upload-icon">üìÅ</div>
                        <div class="file-upload-text">Cliquez pour s√©lectionner un fichier ou glissez-le ici</div>
                        <div class="file-upload-text" style="margin-top: 5px; font-size: 12px; color: #999;">
                            PDF, Word, Excel, PowerPoint - Max 50 MB
                        </div>
                    </div>
                    <input type="file" id="fileInput" style="display: none;"
                           accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" required>
                    <div id="fileInfo" style="margin-top: 10px; color: #666; font-size: 14px;"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddDocumentModal()">Annuler</button>
                    <button type="submit" class="btn-submit">üì§ T√©l√©verser</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè∑Ô∏è Ajouter une cat√©gorie</h2>
                <span class="modal-close" onclick="closeAddCategoryModal()">√ó</span>
            </div>
            <form onsubmit="submitCategory(event)">
                <div class="form-group">
                    <label class="form-label">Nom de la cat√©gorie *</label>
                    <input type="text" class="form-input" id="categoryName" placeholder="Ex: M√©moires" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ic√¥ne (emoji)</label>
                    <input type="text" class="form-input" id="categoryIcon" placeholder="Ex: üìö" maxlength="2">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="categoryDescription" placeholder="Description de la cat√©gorie..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddCategoryModal()">Annuler</button>
                    <button type="submit" class="btn-submit">Cr√©er la cat√©gorie</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== MODAL DE PROFIL SUPPRIM√âE =====
         Raison : Risque de s√©curit√© (modification niveau en version beta)
         La gestion du profil se fait uniquement en version classique
    -->

    <script src="/js/profile-functions.js?v=2025122701"></script>
    <script src="/js/new-dashboard.js?v=20251227e"></script>

    <!-- üîê D√©connexion automatique apr√®s 30 minutes d'inactivit√© (TOUS les utilisateurs) -->
    <script src="/js/auto-logout.js?v=20251228"></script>
</body>
</html>
