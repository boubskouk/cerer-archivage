<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Sessions - Super Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .online-badge {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .online-badge.true { background-color: #10b981; }
        .online-badge.false { background-color: #ef4444; }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-6 shadow-lg">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-3">
                            <h1 class="text-3xl font-bold">üîê Gestion des Sessions Utilisateurs</h1>
                            <span class="px-3 py-1 bg-green-500 text-white text-sm font-bold rounded-full animate-pulse">
                                ‚ö° AUTO-CORRECTION ACTIV√âE
                            </span>
                        </div>
                        <p class="text-blue-100 mt-1">Analyse toutes les 30s et correction automatique des incoh√©rences</p>
                    </div>
                    <a href="/super-admin.html" class="bg-white text-blue-600 px-6 py-2 rounded-lg font-semibold hover:bg-blue-50 transition">
                        ‚Üê Retour Dashboard
                    </a>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8">
            <!-- Actions -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="flex gap-3 justify-between items-center">
                    <div class="text-gray-600">
                        <span id="lastRefresh">Derni√®re actualisation: -</span>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="analyzeSessions()" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:shadow-lg transition flex items-center gap-2">
                            <span>üîÑ</span>
                            <span>Actualiser</span>
                        </button>
                        <button id="fixButton" onclick="fixSessions()" class="bg-gradient-to-r from-red-600 to-pink-600 text-white px-6 py-2 rounded-lg font-semibold hover:shadow-lg transition flex items-center gap-2 hidden">
                            <span>üîß</span>
                            <span>Corriger les incoh√©rences</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üìä Statistiques</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-blue-600" id="totalSessions">0</div>
                        <div class="text-sm text-gray-600 mt-1">Sessions actives (DB)</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-green-600" id="reallyOnline">0</div>
                        <div class="text-sm text-gray-600 mt-1">Vraiment en ligne</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-orange-600" id="markedOnline">0</div>
                        <div class="text-sm text-gray-600 mt-1">Marqu√©s en ligne</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-red-600" id="falsePositives">0</div>
                        <div class="text-sm text-gray-600 mt-1">Faux positifs</div>
                    </div>
                </div>
            </div>

            <!-- Recommandation -->
            <div id="recommendationSection" class="hidden rounded-lg p-4 mb-6">
                <div class="flex items-center gap-3">
                    <span id="recommendationIcon" class="text-2xl"></span>
                    <p id="recommendationText" class="font-semibold"></p>
                </div>
            </div>

            <!-- Utilisateurs vraiment en ligne -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">‚úÖ Utilisateurs vraiment en ligne</h2>
                    <span id="reallyOnlineCount" class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">0</span>
                </div>
                <div class="table-container">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">Statut</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">Username</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">Nom</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">Niveau</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">Derni√®re activit√©</th>
                            </tr>
                        </thead>
                        <tbody id="reallyOnlineTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    Aucun utilisateur connect√©
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Faux positifs -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">‚ö†Ô∏è Faux positifs (marqu√©s en ligne sans session)</h2>
                    <span id="falsePositivesCount" class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold">0</span>
                </div>
                <div class="table-container">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">Statut</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">Username</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">Nom</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">Niveau</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">Probl√®me</th>
                            </tr>
                        </thead>
                        <tbody id="falsePositivesTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    Aucune incoh√©rence d√©tect√©e
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // V√âRIFICATION DE S√âCURIT√â NIVEAU 0
        // ============================================
        (async function() {
            console.log('üîê V√©rification acc√®s Super Admin (Niveau 0)...');

            try {
                const response = await fetch('/api/superadmin/test', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    console.error('‚ùå Acc√®s refus√© - redirection...');
                    alert('‚õî Acc√®s refus√©\n\nCette page est r√©serv√©e aux Super Administrateurs (Niveau 0).\n\nVous allez √™tre redirig√© vers la page de connexion.');
                    window.location.href = '/super-admin-login.html';
                    return;
                }

                const data = await response.json();
                if (!data.success) {
                    console.error('‚ùå Session invalide - redirection...');
                    alert('‚õî Session invalide\n\nVeuillez vous reconnecter en tant que Super Administrateur.');
                    window.location.href = '/super-admin-login.html';
                    return;
                }

                console.log('‚úÖ Acc√®s autoris√© - Niveau 0 confirm√©');
            } catch (error) {
                console.error('‚ùå Erreur v√©rification:', error);
                alert('‚õî Erreur de v√©rification\n\nImpossible de v√©rifier vos permissions.');
                window.location.href = '/super-admin-login.html';
            }
        })();

        let currentAnalysis = null;

        // Analyser les sessions
        async function analyzeSessions() {
            const loadingOverlay = showLoading();

            try {
                const response = await fetch('/api/superadmin/analyze-sessions', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de l\'analyse des sessions');
                }

                const data = await response.json();
                currentAnalysis = data;

                // Mettre √† jour les statistiques
                document.getElementById('totalSessions').textContent = data.analysis.totalSessionsInDB || 0;
                document.getElementById('reallyOnline').textContent = data.analysis.reallyOnline || 0;
                document.getElementById('markedOnline').textContent = data.analysis.usersMarkedOnline || 0;
                document.getElementById('falsePositives').textContent = data.analysis.falsePositives || 0;

                // Afficher la recommandation
                const recSection = document.getElementById('recommendationSection');
                const recIcon = document.getElementById('recommendationIcon');
                const recText = document.getElementById('recommendationText');

                recSection.classList.remove('hidden', 'bg-green-50', 'bg-red-50');

                if (data.analysis.falsePositives > 0) {
                    recSection.classList.add('bg-red-50');
                    recIcon.textContent = '‚ö†Ô∏è';
                    recText.textContent = data.recommendation;
                    recText.className = 'font-semibold text-red-800';
                    document.getElementById('fixButton').classList.remove('hidden');
                } else {
                    recSection.classList.add('bg-green-50');
                    recIcon.textContent = '‚úÖ';
                    recText.textContent = data.recommendation;
                    recText.className = 'font-semibold text-green-800';
                    document.getElementById('fixButton').classList.add('hidden');
                }

                // Remplir le tableau des utilisateurs vraiment en ligne
                fillReallyOnlineTable(data.reallyOnline || []);

                // Remplir le tableau des faux positifs
                fillFalsePositivesTable(data.falsePositives || []);

                // üîß CORRECTION AUTOMATIQUE: Si des faux positifs sont d√©tect√©s, les corriger automatiquement
                if (data.analysis.falsePositives > 0) {
                    console.log(`‚ö° Auto-correction: ${data.analysis.falsePositives} faux positif(s) d√©tect√©(s)`);
                    await autoFixSessions();
                }

                // Mettre √† jour l'heure
                document.getElementById('lastRefresh').textContent =
                    'Derni√®re actualisation: ' + new Date().toLocaleString('fr-FR');

            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de l\'analyse: ' + error.message);
            } finally {
                hideLoading(loadingOverlay);
            }
        }

        // Remplir le tableau des utilisateurs vraiment en ligne
        function fillReallyOnlineTable(users) {
            const tbody = document.getElementById('reallyOnlineTable');
            const count = document.getElementById('reallyOnlineCount');

            count.textContent = users.length;

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            Aucun utilisateur connect√©
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <span class="online-badge true"></span>
                        <span class="text-green-600 font-semibold">En ligne</span>
                    </td>
                    <td class="py-3 px-4 font-medium">${escapeHtml(user.username)}</td>
                    <td class="py-3 px-4">${escapeHtml(user.nom || '-')}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${getNiveauColor(user.niveau)}">
                            Niveau ${user.niveau}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600">
                        ${user.lastActivity ? new Date(user.lastActivity).toLocaleString('fr-FR') : '-'}
                    </td>
                </tr>
            `).join('');
        }

        // Remplir le tableau des faux positifs
        function fillFalsePositivesTable(users) {
            const tbody = document.getElementById('falsePositivesTable');
            const count = document.getElementById('falsePositivesCount');

            count.textContent = users.length;

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            ‚úÖ Aucune incoh√©rence d√©tect√©e
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="border-b border-gray-100 hover:bg-red-50">
                    <td class="py-3 px-4">
                        <span class="online-badge true"></span>
                        <span class="text-red-600 font-semibold">Marqu√© en ligne</span>
                    </td>
                    <td class="py-3 px-4 font-medium">${escapeHtml(user.username)}</td>
                    <td class="py-3 px-4">${escapeHtml(user.nom || '-')}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${getNiveauColor(user.niveau)}">
                            Niveau ${user.niveau}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-sm text-red-600">
                        ‚ö†Ô∏è Aucune session active dans la base
                    </td>
                </tr>
            `).join('');
        }

        // Corriger les incoh√©rences
        async function fixSessions() {
            if (!currentAnalysis || currentAnalysis.analysis.falsePositives === 0) {
                alert('Aucune incoh√©rence √† corriger');
                return;
            }

            const confirm = window.confirm(
                `‚ö†Ô∏è Vous allez corriger ${currentAnalysis.analysis.falsePositives} utilisateur(s).\n\n` +
                `Leur statut "isOnline" sera mis √† false.\n\n` +
                `Continuer ?`
            );

            if (!confirm) return;

            const loadingOverlay = showLoading();

            try {
                const response = await fetch('/api/superadmin/fix-sessions', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la correction');
                }

                const data = await response.json();

                alert(`‚úÖ ${data.message}\n\n${data.usersUpdated} utilisateur(s) corrig√©(s)`);

                // R√©actualiser l'analyse
                await analyzeSessions();

            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la correction: ' + error.message);
            } finally {
                hideLoading(loadingOverlay);
            }
        }

        // üîß AUTO-CORRECTION SILENCIEUSE (sans confirmation ni alert)
        async function autoFixSessions() {
            if (!currentAnalysis || currentAnalysis.analysis.falsePositives === 0) {
                return;
            }

            try {
                console.log(`üîß Auto-correction en cours de ${currentAnalysis.analysis.falsePositives} utilisateur(s)...`);

                const response = await fetch('/api/superadmin/fix-sessions', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la correction automatique');
                }

                const data = await response.json();
                console.log(`‚úÖ Auto-correction r√©ussie: ${data.usersUpdated} utilisateur(s) corrig√©(s)`);

                // Attendre 2 secondes puis r√©actualiser pour voir les changements
                setTimeout(async () => {
                    await analyzeSessions();
                }, 2000);

            } catch (error) {
                console.error('‚ùå Erreur auto-correction:', error);
                // Ne pas afficher d'alert pour ne pas interrompre l'utilisateur
            }
        }

        // Utilitaires
        function getNiveauColor(niveau) {
            const colors = {
                0: 'bg-purple-100 text-purple-800',
                1: 'bg-blue-100 text-blue-800',
                2: 'bg-green-100 text-green-800',
                3: 'bg-gray-100 text-gray-800'
            };
            return colors[niveau] || 'bg-gray-100 text-gray-800';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            overlay.innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow-2xl">
                    <div class="flex items-center gap-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <span class="text-lg font-semibold">Analyse en cours...</span>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            return overlay;
        }

        function hideLoading(overlay) {
            if (overlay && overlay.parentNode) {
                overlay.parentNode.removeChild(overlay);
            }
        }

        // Charger automatiquement au d√©marrage
        window.addEventListener('DOMContentLoaded', () => {
            analyzeSessions();
        });

        // Auto-refresh toutes les 30 secondes
        setInterval(() => {
            analyzeSessions();
        }, 30000);
    </script>

    <!-- üîê D√©connexion automatique apr√®s 5 minutes d'inactivit√© (Super Admin uniquement) -->
    <!-- Syst√®me de logging centralis√© -->
    <script src="js/logger.js?v=20250104"></script>
    <script src="js/superadmin-auto-logout.js?v=20251228"></script>
</body>
</html>
