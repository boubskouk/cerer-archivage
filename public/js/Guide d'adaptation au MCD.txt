# ğŸ“‹ Guide d'Adaptation au MCD - Application d'Archivage C.E.R.E.R

## ğŸ¯ Vue d'ensemble

Ce guide dÃ©taille les modifications nÃ©cessaires pour adapter votre application au ModÃ¨le Conceptuel de DonnÃ©es (MCD).

---

## ğŸ“Š SchÃ©ma de la Base de DonnÃ©es

### Collections MongoDB

#### 1. **roles**
```javascript
{
  _id: ObjectId,
  libelle: String,        // "primaire" | "secondaire" | "tertiaire"
  niveau: Number,         // 1 (max droits) | 2 | 3 (min droits)
  description: String
}
```

#### 2. **departements**
```javascript
{
  _id: ObjectId,
  nom: String,
  description: String
}
```

#### 3. **users**
```javascript
{
  _id: ObjectId,
  username: String,       // Unique
  nom: String,
  email: String,
  password: String,       // HashÃ©
  idRole: ObjectId,       // RÃ©fÃ©rence Ã  roles
  idDepartement: ObjectId,// RÃ©fÃ©rence Ã  departements
  dateCreation: Date
}
```

#### 4. **documents**
```javascript
{
  _id: ObjectId,
  titre: String,
  description: String,
  fichier: String,        // Base64
  dateAjout: Date,
  idUtilisateur: String,  // username du crÃ©ateur
  idCategorie: String,
  idDepartement: ObjectId,// RÃ©fÃ©rence au dÃ©partement
  nomFichier: String,
  taille: Number,
  type: String,
  contenu: String,
  tags: String
}
```

#### 5. **categories**
```javascript
{
  _id: ObjectId,
  id: String,
  nom: String,
  couleur: String,
  icon: String,
  idUtilisateur: String
}
```

---

## ğŸ” HiÃ©rarchie des RÃ´les et Permissions

### RÃ¨gles d'accÃ¨s

#### Niveau 1 - RÃ´le Primaire
- âœ… AccÃ¨s COMPLET Ã  tous les documents du dÃ©partement
- âœ… Peut voir/modifier/supprimer documents de niveau 2 et 3
- âœ… Gestion complÃ¨te du dÃ©partement

#### Niveau 2 - RÃ´le Secondaire
- âœ… AccÃ¨s Ã  ses documents
- âœ… AccÃ¨s aux documents de niveau 3 dans son dÃ©partement
- âŒ Ne peut pas voir les documents primaires

#### Niveau 3 - RÃ´le Tertiaire
- âœ… AccÃ¨s uniquement Ã  ses propres documents
- âŒ Ne peut pas voir les documents d'autres utilisateurs

### Isolation par DÃ©partement
- Les documents sont **strictement isolÃ©s** par dÃ©partement
- Un utilisateur ne voit JAMAIS les documents d'un autre dÃ©partement
- Exception : Un administrateur systÃ¨me pourrait avoir accÃ¨s global

---

## ğŸ”§ Modifications des Fichiers

### 1. **server.js** â†’ Remplacer par **server-mcd-adapte.js**

**Changements principaux :**
- âœ… Ajout des collections `roles` et `departements`
- âœ… Fonction `canAccessDocument()` pour contrÃ´le d'accÃ¨s
- âœ… Fonction `getAccessibleDocuments()` avec filtrage hiÃ©rarchique
- âœ… Initialisation des rÃ´les et dÃ©partements par dÃ©faut
- âœ… Modification des routes pour gÃ©rer les permissions

### 2. **api.js** - Modifications nÃ©cessaires

```javascript
// Ajouter ces nouvelles fonctions

async function getRoles() {
    return await apiCall('/roles');
}

async function getDepartements() {
    return await apiCall('/departements');
}

async function getUserInfo(username) {
    return await apiCall(`/users/${username}`);
}
```

### 3. **app.js** - Modifications de l'Ã©tat

```javascript
const state = {
    documents: [],
    categories: [],
    user: null,           // NOUVEAU: Infos complÃ¨tes utilisateur
    userRole: null,       // NOUVEAU: RÃ´le de l'utilisateur
    userDepartement: null,// NOUVEAU: DÃ©partement
    roles: [],            // NOUVEAU: Liste des rÃ´les
    departements: [],     // NOUVEAU: Liste des dÃ©partements
    // ... reste inchangÃ©
};
```

### 4. **auth.js** - Adapter la connexion

```javascript
async function login(username, password) {
    try {
        const result = await loginUser(username, password);
        
        if (result.success) {
            state.currentUser = username;
            state.isAuthenticated = true;
            state.user = result.user;  // NOUVEAU
            await loadData();
            await loadRolesAndDepts(); // NOUVEAU
            showNotification(`âœ… Bienvenue ${result.user.nom}!`);
            return true;
        }
    } catch (error) {
        return false;
    }
}

async function loadRolesAndDepts() {
    state.roles = await getRoles();
    state.departements = await getDepartements();
    render();
}
```

---

## ğŸ“ Exemples d'Utilisation

### ScÃ©nario 1 : Fatima (Primaire, Direction)
```
âœ… Peut voir TOUS les documents de la Direction
âœ… Peut voir les documents d'Awa (Secondaire, Direction)
âœ… Peut modifier/supprimer ces documents
âŒ Ne peut PAS voir les documents de ComptabilitÃ©
```

### ScÃ©nario 2 : Awa (Secondaire, Direction)
```
âœ… Peut voir ses propres documents
âœ… Peut voir les documents Tertiaires de la Direction
âŒ Ne peut PAS voir les documents de Fatima (Primaire)
âŒ Ne peut PAS voir les documents de ComptabilitÃ©
```

### ScÃ©nario 3 : Deguene (Tertiaire, ComptabilitÃ©)
```
âœ… Peut voir uniquement SES documents
âŒ Ne peut PAS voir les documents de JBK (Primaire, Compta)
âŒ Ne peut PAS voir les documents de Direction
```

### ScÃ©nario 4 : JBK (Primaire, ComptabilitÃ©)
```
âœ… Peut voir TOUS les documents de ComptabilitÃ©
âœ… Peut voir les documents de Deguene (Tertiaire, Compta)
âœ… Peut modifier/supprimer les documents du dÃ©partement
âŒ Ne peut PAS voir les documents de Direction
```

---

## ğŸš€ Migration des DonnÃ©es Existantes

### Script de Migration MongoDB

```javascript
// migration.js - Ã€ exÃ©cuter dans MongoDB Shell ou Node.js

const { MongoClient, ObjectId } = require('mongodb');

async function migrate() {
    const client = await MongoClient.connect('mongodb://localhost:27017');
    const db = client.db('cerer_archivage');
    
    // 1. RÃ©cupÃ©rer les rÃ´les et dÃ©partements
    const primaryRole = await db.collection('roles').findOne({ libelle: 'primaire' });
    const directionDept = await db.collection('departements').findOne({ nom: 'Direction' });
    
    // 2. Mettre Ã  jour les utilisateurs existants
    await db.collection('users').updateMany(
        { idRole: { $exists: false } },
        { 
            $set: { 
                idRole: primaryRole._id,
                idDepartement: directionDept._id,
                nom: '',
                email: ''
            } 
        }
    );
    
    // 3. Mettre Ã  jour les documents existants
    const users = await db.collection('users').find().toArray();
    
    for (const user of users) {
        await db.collection('documents').updateMany(
            { userId: user.username },
            { 
                $set: { 
                    idUtilisateur: user.username,
                    idDepartement: user.idDepartement 
                },
                $unset: { userId: "" }
            }
        );
    }
    
    // 4. Mettre Ã  jour les catÃ©gories
    for (const user of users) {
        await db.collection('categories').updateMany(
            { userId: user.username },
            { 
                $set: { 
                    idUtilisateur: user.username
                },
                $unset: { userId: "" }
            }
        );
    }
    
    console.log('âœ… Migration terminÃ©e');
    await client.close();
}

migrate().catch(console.error);
```

---

## ğŸ¨ Modifications Interface Utilisateur

### Affichage des Informations Utilisateur

```javascript
// Dans le header de l'application
function renderUserInfo() {
    return `
        <div class="user-info">
            <div class="user-avatar">${state.user.nom.charAt(0)}</div>
            <div>
                <p class="font-bold">${state.user.nom}</p>
                <p class="text-sm text-gray-600">
                    ${state.user.role} â€¢ ${state.user.departement}
                </p>
            </div>
        </div>
    `;
}
```

### Badge de RÃ´le sur les Documents

```javascript
function renderDocumentCard(doc) {
    const isOwner = doc.idUtilisateur === state.currentUser;
    const canModify = isOwner || state.user.roleNiveau === 1;
    
    return `
        <div class="doc-card">
            <h3>${doc.titre}</h3>
            
            ${!isOwner ? `
                <span class="text-xs badge badge-info">
                    ğŸ“¤ PartagÃ© par ${doc.idUtilisateur}
                </span>
            ` : ''}
            
            <div class="actions">
                <button onclick="viewDoc('${doc._id}')">ğŸ‘ï¸ Voir</button>
                ${canModify ? `
                    <button onclick="deleteDoc('${doc._id}')">ğŸ—‘ï¸ Supprimer</button>
                ` : ''}
            </div>
        </div>
    `;
}
```

### Formulaire d'Inscription AmÃ©liorÃ©

```javascript
function renderRegisterForm() {
    return `
        <form>
            <input type="text" placeholder="Nom complet" required />
            <input type="text" placeholder="Username" required />
            <input type="email" placeholder="Email" required />
            <input type="password" placeholder="Mot de passe" required />
            
            <select name="role" required>
                <option value="">-- Choisir un rÃ´le --</option>
                ${state.roles.map(role => `
                    <option value="${role._id}">
                        ${role.libelle} - ${role.description}
                    </option>
                `).join('')}
            </select>
            
            <select name="departement" required>
                <option value="">-- Choisir un dÃ©partement --</option>
                ${state.departements.map(dept => `
                    <option value="${dept._id}">
                        ${dept.nom}
                    </option>
                `).join('')}
            </select>
            
            <button type="submit">CrÃ©er le compte</button>
        </form>
    `;
}
```

---

## ğŸ” Tests de Validation

### Test 1 : AccÃ¨s aux Documents par HiÃ©rarchie

```javascript
// ScÃ©nario : VÃ©rifier qu'un utilisateur Tertiaire ne voit que ses docs
async function testTertiaryAccess() {
    // Se connecter en tant que Deguene (Tertiaire, Compta)
    await login('deguene', '3576');
    
    const docs = await getDocuments('deguene');
    
    // VÃ©rifier que tous les docs appartiennent Ã  Deguene
    const allMine = docs.every(doc => doc.idUtilisateur === 'deguene');
    
    console.assert(allMine, 'Tertiaire ne devrait voir que ses docs');
}
```

### Test 2 : Isolation par DÃ©partement

```javascript
// ScÃ©nario : VÃ©rifier l'isolation entre dÃ©partements
async function testDepartmentIsolation() {
    // Fatima (Direction) ne doit pas voir les docs de Compta
    await login('fatima', '1234');
    
    const fatimaDocs = await getDocuments('fatima');
    const comptaDocs = fatimaDocs.filter(doc => 
        doc.idDepartement.toString() !== state.user.idDepartement.toString()
    );
    
    console.assert(comptaDocs.length === 0, 'Isolation dÃ©partement OK');
}
```

### Test 3 : AccÃ¨s Primaire

```javascript
// ScÃ©nario : Un Primaire voit tous les docs de son dÃ©partement
async function testPrimaryAccess() {
    await login('jbk', '0811');
    
    const docs = await getDocuments('jbk');
    
    // JBK devrait voir ses docs + ceux de Deguene (mÃªme dept)
    const hasOthersDocs = docs.some(doc => doc.idUtilisateur !== 'jbk');
    
    console.assert(hasOthersDocs, 'Primaire voit docs du dÃ©partement');
}
```

---

## ğŸ“¦ Installation et DÃ©ploiement

### Ã‰tape 1 : Sauvegarder les DonnÃ©es Actuelles

```bash
# Export MongoDB
mongodump --db cerer_archivage --out ./backup
```

### Ã‰tape 2 : Remplacer le Serveur

```bash
# ArrÃªter l'ancien serveur
# Ctrl+C ou pm2 stop server

# Remplacer server.js par server-mcd-adapte.js
mv server.js server-old.js
mv server-mcd-adapte.js server.js

# Installer les dÃ©pendances (si nouvelles)
npm install
```

### Ã‰tape 3 : ExÃ©cuter la Migration

```bash
# Lancer le script de migration
node migration.js
```

### Ã‰tape 4 : DÃ©marrer le Nouveau Serveur

```bash
node server.js
# ou avec PM2
pm2 start server.js --name cerer-archivage
```

### Ã‰tape 5 : VÃ©rifications

```bash
# Tester la connexion
curl http://localhost:4000/health

# Tester le login
curl -X POST http://localhost:4000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"fatima","password":"1234"}'

# VÃ©rifier les rÃ´les
curl http://localhost:4000/api/roles

# VÃ©rifier les dÃ©partements
curl http://localhost:4000/api/departements
```

---

## ğŸ› ï¸ Gestion des RÃ´les et DÃ©partements

### Ajouter un Nouveau RÃ´le

```javascript
// Route API Ã  ajouter dans server.js
app.post('/api/roles', async (req, res) => {
    const { libelle, niveau, description } = req.body;
    
    await rolesCollection.insertOne({
        libelle,
        niveau: parseInt(niveau),
        description
    });
    
    res.json({ success: true });
});
```

### Ajouter un Nouveau DÃ©partement

```javascript
app.post('/api/departements', async (req, res) => {
    const { nom, description } = req.body;
    
    await departementsCollection.insertOne({
        nom,
        description
    });
    
    res.json({ success: true });
});
```

### Changer le RÃ´le d'un Utilisateur

```javascript
app.put('/api/users/:username/role', async (req, res) => {
    const { username } = req.params;
    const { newRoleId } = req.body;
    
    await usersCollection.updateOne(
        { username },
        { $set: { idRole: new ObjectId(newRoleId) } }
    );
    
    res.json({ success: true });
});
```

---

## ğŸ¯ FonctionnalitÃ©s AvancÃ©es

### 1. Statistiques par DÃ©partement

```javascript
app.get('/api/stats/departement/:deptId', async (req, res) => {
    const { deptId } = req.params;
    
    const docCount = await documentsCollection.countDocuments({
        idDepartement: new ObjectId(deptId)
    });
    
    const userCount = await usersCollection.countDocuments({
        idDepartement: new ObjectId(deptId)
    });
    
    res.json({ docCount, userCount });
});
```

### 2. Journal d'Audit

```javascript
// CrÃ©er une collection 'audit_logs'
async function logAction(userId, action, details) {
    await db.collection('audit_logs').insertOne({
        userId,
        action, // 'view', 'create', 'update', 'delete'
        details,
        timestamp: new Date()
    });
}

// Utilisation
app.get('/api/documents/:userId/:docId', async (req, res) => {
    // ... code existant ...
    
    await logAction(userId, 'view', { documentId: docId });
    
    res.json(document);
});
```

### 3. Notifications Inter-DÃ©partements

```javascript
// Pour partager un document entre dÃ©partements
app.post('/api/documents/:docId/share', async (req, res) => {
    const { docId } = req.params;
    const { targetDepartementId, userId } = req.body;
    
    // CrÃ©er une copie du document dans l'autre dÃ©partement
    const originalDoc = await documentsCollection.findOne({
        _id: new ObjectId(docId)
    });
    
    const sharedDoc = {
        ...originalDoc,
        _id: undefined,
        idDepartement: new ObjectId(targetDepartementId),
        sharedFrom: userId,
        sharedAt: new Date()
    };
    
    await documentsCollection.insertOne(sharedDoc);
    
    res.json({ success: true });
});
```

---

## âš ï¸ Points d'Attention

### SÃ©curitÃ©
- âœ… Toujours vÃ©rifier les permissions avant chaque opÃ©ration
- âœ… Valider que l'utilisateur appartient au dÃ©partement
- âœ… Ne jamais exposer les documents d'autres dÃ©partements
- âœ… Logger les actions sensibles

### Performance
- âœ… CrÃ©er des index sur `idDepartement` et `idUtilisateur`
- âœ… Utiliser `projection` pour ne pas charger le contenu des fichiers
- âœ… Paginer les rÃ©sultats si beaucoup de documents
- âœ… Mettre en cache les rÃ´les et dÃ©partements

### Maintenance
- âœ… Sauvegarder rÃ©guliÃ¨rement la base de donnÃ©es
- âœ… Surveiller l'espace disque utilisÃ©
- âœ… Nettoyer les documents orphelins
- âœ… Archiver les vieux logs d'audit

---

## ğŸ“ Support et Assistance

Pour toute question sur l'adaptation au MCD :

1. **VÃ©rifier les logs** : `tail -f logs/server.log`
2. **Tester les permissions** : Utiliser les tests fournis
3. **Consulter MongoDB** : `mongo cerer_archivage`
4. **RÃ©initialiser** : Supprimer la DB et relancer (dev uniquement)

---

## âœ… Checklist de Migration

- [ ] Sauvegarder les donnÃ©es actuelles
- [ ] Remplacer server.js
- [ ] ExÃ©cuter le script de migration
- [ ] Tester la connexion de chaque utilisateur
- [ ] VÃ©rifier l'accÃ¨s aux documents selon les rÃ´les
- [ ] Valider l'isolation des dÃ©partements
- [ ] Tester la crÃ©ation de documents
- [ ] Tester la suppression avec permissions
- [ ] Mettre Ã  jour l'interface utilisateur
- [ ] Former les utilisateurs aux nouveaux rÃ´les
- [ ] Documenter les changements
- [ ] DÃ©ployer en production

---

## ğŸ“ Conclusion

Cette adaptation transforme votre application en un systÃ¨me **multi-dÃ©partements** avec **gestion hiÃ©rarchique des droits**, conforme au MCD spÃ©cifiÃ©. 

Les utilisateurs bÃ©nÃ©ficient maintenant de :
- ğŸ” SÃ©curitÃ© renforcÃ©e par dÃ©partement
- ğŸ‘¥ Collaboration contrÃ´lÃ©e selon les rÃ´les
- ğŸ“Š VisibilitÃ© adaptÃ©e aux responsabilitÃ©s
- ğŸ›¡ï¸ Protection des donnÃ©es sensibles

**Bon courage pour la migration ! ğŸš€**